name: üèóÔ∏è Build and Tag

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write
  actions: write

jobs:
  build:
    name: üß™ Build & Test
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.release_check.outputs.should-release }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ‚úÖ Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: üîß Setup Gradle cache
        uses: gradle/actions/setup-gradle@v4

      - name: üî® Make gradlew executable
        run: chmod +x ./gradlew

      - name: üß™ Run tests & build
        run: |
          echo "::group::Gradle build"
          ./gradlew clean test bootJar --console=plain
          echo "::endgroup::"

      - name: üì¶ Capture JAR details
        id: artifact
        run: |
          JAR_FILE=$(find build/libs -name "*.jar" -not -name "*-plain.jar" | head -1)
          if [[ -z "$JAR_FILE" ]]; then
            echo "No bootable JAR produced" >&2
            exit 1
          fi
          echo "jar-path=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "jar-name=$(basename "$JAR_FILE")" >> $GITHUB_OUTPUT

      - name: üì§ Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: ${{ steps.artifact.outputs.jar-path }}
          retention-days: 30

      - name: üéØ Determine release eligibility
        id: release_check
        run: |
          if [[ "${{ github.actor }}" == "github-actions[bot]" ]]; then
            echo "should-release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          case "$ref_name" in
            main|master) ;;
            *)
              echo "should-release=false" >> $GITHUB_OUTPUT
              exit 0
              ;;
          esac

          if [[ "$last_commit_msg" =~ \[skip[ -]?release\] ]]; then
            echo "should-release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should-release=true" >> $GITHUB_OUTPUT
          echo "Release eligibility determined: ${{ steps.release_check.outputs.should-release }}"

  version:
    name: üè∑Ô∏è Version & Tag
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.should-release == 'true'
    outputs:
      new-version: ${{ steps.version_calc.outputs.new-version }}
      new-version-no-v: ${{ steps.version_calc.outputs.new-version-no-v }}
      increment-type: ${{ steps.version_calc.outputs.increment-type }}
      emoji: ${{ steps.version_calc.outputs.emoji }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Determine next version
        id: version_calc
        run: |
          echo "::group::Calculating version"
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.1")
          VERSION=${LATEST_TAG#v}
          IFS='.' read -ra PARTS <<< "$VERSION"
          MAJOR=${PARTS[0]:-0}
          MINOR=${PARTS[1]:-0}
          PATCH=${PARTS[2]:-0}

          COMMIT_MSG=$(git log -1 --pretty=%B || echo "")
          if [[ "$COMMIT_MSG" =~ ^.*! ]]; then
            ((MAJOR++)); MINOR=0; PATCH=0; INCREMENT="major"; EMOJI="üöÄ"
          elif [[ "$COMMIT_MSG" =~ \(feat\) ]]; then
            ((MINOR++)); PATCH=0; INCREMENT="minor"; EMOJI="‚ú®"
          elif [[ "$COMMIT_MSG" =~ \(fix\) || "$COMMIT_MSG" =~ \(chore\) ]]; then
            ((PATCH++)); INCREMENT="patch"; EMOJI="üêõ"
          else
            ((MINOR++)); PATCH=0; INCREMENT="minor"; EMOJI="‚ú®"
          fi

          NEW_VERSION_NO_V="$MAJOR.$MINOR.$PATCH"
          NEW_VERSION="v$NEW_VERSION_NO_V"

          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new-version-no-v=$NEW_VERSION_NO_V" >> $GITHUB_OUTPUT
          echo "increment-type=$INCREMENT" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "$EMOJI $LATEST_TAG -> $NEW_VERSION ($INCREMENT)"
          echo "::endgroup::"

      - name: üìù Update build.gradle
        env:
          NEW_VERSION_NO_V: ${{ steps.version_calc.outputs.new-version-no-v }}
        run: |
          python - <<'PY'
          import os, pathlib, re
          path = pathlib.Path('build.gradle')
          text = path.read_text()
          new_version = os.environ['NEW_VERSION_NO_V']
          updated, count = re.subn(r'version\s*=\s*["\"][^"\"]+["\"]', f'version = "{new_version}"', text, count=1)
          if count == 0:
              raise SystemExit('Failed to update version in build.gradle')
          path.write_text(updated)
          print(f"Updated build.gradle to {new_version}")
          PY

      - name: üìÑ Show version change
        run: grep "version =" -n build.gradle

      - name: üìö Commit version bump
        env:
          NEW_VERSION: ${{ steps.version_calc.outputs.new-version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add build.gradle
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
          git push origin ${{ github.ref_name }}

      - name: üè∑Ô∏è Create annotated tag
        env:
          NEW_VERSION: ${{ steps.version_calc.outputs.new-version }}
          INCREMENT: ${{ steps.version_calc.outputs.increment-type }}
          EMOJI: ${{ steps.version_calc.outputs.emoji }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$NEW_VERSION" -m "$EMOJI Auto $INCREMENT release $NEW_VERSION"
          git push origin "$NEW_VERSION"

  release:
    name: üöÄ Publish Release
    runs-on: ubuntu-latest
    needs: version
    if: needs.version.result == 'success'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì• Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: downloaded-jar

      - name: üîÑ Rename JAR to release version
        id: final_jar
        env:
          NEW_VERSION_NO_V: ${{ needs.version.outputs.new-version-no-v }}
        run: |
          ORIGINAL_JAR=$(find downloaded-jar -name "*.jar" | head -1)
          if [[ -z "$ORIGINAL_JAR" ]]; then
            echo "No artifact found" >&2
            exit 1
          fi
          BASE_NAME=$(basename "$ORIGINAL_JAR" | sed -E 's/-[0-9]+\.[0-9]+\.[0-9]+.*\.jar$//')
          NEW_NAME="${BASE_NAME}-${NEW_VERSION_NO_V}.jar"
          NEW_PATH="downloaded-jar/$NEW_NAME"
          if [[ "$ORIGINAL_JAR" != "$NEW_PATH" ]]; then
            mv "$ORIGINAL_JAR" "$NEW_PATH"
          fi
          echo "jar-path=$NEW_PATH" >> $GITHUB_OUTPUT
          echo "jar-name=$NEW_NAME" >> $GITHUB_OUTPUT

      - name: üì¶ Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_VERSION: ${{ needs.version.outputs.new-version }}
          INCREMENT: ${{ needs.version.outputs.increment-type }}
          EMOJI: ${{ needs.version.outputs.emoji }}
          JAR_NAME: ${{ steps.final_jar.outputs.jar-name }}
          JAR_PATH: ${{ steps.final_jar.outputs.jar-path }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B || echo "")
          NOTES_FILE=$(mktemp)
          {
            echo "## $EMOJI Release"
            echo "Auto-generated release for $NEW_VERSION"
            echo ""
            echo "- Increment: $INCREMENT"
            echo "- Triggered by: ${{ github.actor }}"
            echo ""
            echo "### üì¶ Artifact"
            echo "- $JAR_NAME"
            echo ""
            echo "### üí¨ Commit Message"
            echo '```'
            echo "$COMMIT_MSG"
            echo '```'
          } > "$NOTES_FILE"
          gh release create "$NEW_VERSION" --title "$EMOJI Release $NEW_VERSION" --notes-file "$NOTES_FILE" "$JAR_PATH"
